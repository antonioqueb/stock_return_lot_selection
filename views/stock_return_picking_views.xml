<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_stock_return_picking_form_lot_selection" model="ir.ui.view">
        <field name="name">stock.return.picking.form.lot.selection</field>
        <field name="model">stock.return.picking</field>
        <field name="inherit_id" ref="stock.view_stock_return_picking_form"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='product_return_moves']" position="before">
                <div invisible="not has_lot_products" class="alert alert-info mb-2" role="alert">
                    <strong>ðŸ“¦ Productos con lotes detectados.</strong>
                    Agregue o quite lotes con las etiquetas. La cantidad se calcula automÃ¡ticamente.
                </div>
                <field name="has_lot_products" invisible="1"/>
            </xpath>

            <xpath expr="//field[@name='product_return_moves']/list" position="replace">
                <list editable="bottom"
                      create="1"
                      decoration-warning="not move_id"
                      decoration-success="to_return and is_lot_tracked"
                      decoration-muted="is_lot_tracked and not to_return">

                    <!-- Campos tÃ©cnicos ocultos -->
                    <field name="move_quantity" column_invisible="1"/>
                    <field name="move_id" column_invisible="True"/>
                    <field name="is_lot_tracked" column_invisible="1"/>
                    <field name="lot_qty_json" column_invisible="1"/>
                    <field name="allowed_lot_ids" column_invisible="1"/>

                    <!-- Checkbox -->
                    <field name="to_return" string="âœ“" width="40px"/>

                    <!-- Producto -->
                    <field name="product_id" force_save="1" readonly="is_lot_tracked"/>

                    <!-- Lotes como tags -->
                    <field name="lot_ids"
                           string="Lotes a Devolver"
                           widget="many2many_tags"
                           domain="[('id', 'in', allowed_lot_ids)]"
                           options="{'no_create': True}"/>

                    <!-- Cantidad (auto-calculada) -->
                    <field name="quantity"
                           string="Cantidad Total"
                           decoration-danger="move_quantity &lt; quantity"/>

                    <!-- UdM -->
                    <field name="uom_id" widget="many2one_uom" groups="uom.group_uom"/>
                </list>
            </xpath>

        </field>
    </record>

</odoo>