<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_stock_return_picking_form_lot_selection" model="ir.ui.view">
        <field name="name">stock.return.picking.form.lot.selection</field>
        <field name="model">stock.return.picking</field>
        <field name="inherit_id" ref="stock.view_stock_return_picking_form"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">

            <!-- Indicador arriba del tree -->
            <xpath expr="//field[@name='product_return_moves']" position="before">
                <div invisible="not has_lot_products" class="alert alert-info mb-2" role="alert">
                    <strong>ðŸ“¦ Productos con lotes detectados.</strong>
                    Seleccione el lote a devolver y la cantidad se auto-completa.
                    Use la casilla <strong>"âœ“"</strong> para desmarcar los que no desea devolver.
                </div>
                <field name="has_lot_products" invisible="1"/>
            </xpath>

            <!-- Reemplazar el tree -->
            <xpath expr="//field[@name='product_return_moves']/list" position="replace">
                <list editable="bottom"
                      create="1"
                      decoration-warning="not move_id"
                      decoration-success="to_return and is_lot_tracked"
                      decoration-muted="is_lot_tracked and not to_return">

                    <!-- Campos tÃ©cnicos ocultos -->
                    <field name="move_quantity" column_invisible="1"/>
                    <field name="move_id" column_invisible="True"/>
                    <field name="is_lot_tracked" column_invisible="1"/>
                    <field name="lot_delivered_qty" column_invisible="1"/>
                    <field name="allowed_lot_ids" column_invisible="1"/>

                    <!-- Checkbox -->
                    <field name="to_return" string="âœ“" width="40px"/>

                    <!-- Producto -->
                    <field name="product_id" force_save="1" readonly="is_lot_tracked"/>

                    <!-- Lote con dominio filtrado a solo los de la entrega -->
                    <field name="lot_id"
                           string="Lote / Serie"
                           domain="[('id', 'in', allowed_lot_ids)]"
                           options="{'no_create': True, 'no_open': True}"/>

                    <!-- Campos del lote -->
                    <field name="lot_bloque" string="Bloque" optional="show"/>
                    <field name="lot_numero_placa" string="No. Placa" optional="show"/>
                    <field name="lot_atado" string="Atado" optional="hide"/>
                    <field name="lot_grosor" string="Grosor" optional="show"/>
                    <field name="lot_alto" string="Alto" optional="hide"/>
                    <field name="lot_ancho" string="Ancho" optional="hide"/>
                    <field name="lot_peso" string="Peso" optional="hide"/>
                    <field name="lot_color" string="Color" optional="hide"/>
                    <field name="lot_pedimento" string="Pedimento" optional="hide"/>
                    <field name="lot_contenedor" string="Contenedor" optional="hide"/>
                    <field name="lot_origen" string="Origen" optional="hide"/>
                    <field name="lot_proveedor" string="Proveedor" optional="hide"/>
                    <field name="lot_tipo" string="Tipo" optional="hide"/>
                    <field name="lot_detalles" string="Nota" optional="hide"/>

                    <!-- Cantidad -->
                    <field name="quantity"
                           string="Cantidad a Devolver"
                           decoration-danger="move_quantity &lt; quantity"/>

                    <!-- UdM -->
                    <field name="uom_id" widget="many2one_uom" groups="uom.group_uom"/>
                </list>
            </xpath>

        </field>
    </record>

</odoo>